name: Clone Issue to Matching Repo on Label

on:
  issues:
    types: [labeled]
  workflow_dispatch:
    inputs:
      target_repo:
        description: Target repository (owner/repo)
        required: true
        default: WDP-Server/WDP-BaseDet

permissions:
  contents: read
  issues: write

jobs:
  clone-issue:
    runs-on: ubuntu-latest

    steps:
      - name: Determine target repository
        id: target
        run: |
          if [ "${{ github.event_name }}" = "issues" ]; then
            LABEL="${{ github.event.label.name }}"
            if [[ "$LABEL" == WDP-* ]]; then
              echo "repo=${{ github.repository_owner }}/$LABEL" >> "$GITHUB_OUTPUT"
              echo "should_clone=true" >> "$GITHUB_OUTPUT"
            else
              echo "should_clone=false" >> "$GITHUB_OUTPUT"
            fi
          else
            echo "repo=${{ inputs.target_repo }}" >> "$GITHUB_OUTPUT"
            echo "should_clone=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Clone issue to target repo
        if: steps.target.outputs.should_clone == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          printf "%s\n\n---\nOriginal issue: %s\n" \
            "${{ github.event.issue.body }}" \
            "${{ github.event.issue.html_url }}" > body.txt

          gh issue create \
            --repo "${{ steps.target.outputs.repo }}" \
            --title "${{ github.event.issue.title }}" \
            --body-file body.txt
